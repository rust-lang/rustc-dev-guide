<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Canonicalization - Rust Compiler Development Guide</title>


        <!-- Custom HTML head -->

        <meta name="description" content="A guide to developing the Rust compiler (rustc)">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="../highlight.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="../tomorrow-night.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="../pagetoc.css">


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "../";
            const default_light_theme = "light";
            const default_dark_theme = "navy";
            window.path_to_searchindex_js = "../searchindex.js";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../toc.js"></script>
    </head>
    <body>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>←</kbd> or <kbd>→</kbd> to navigate between chapters</p>
                <p>Press <kbd>S</kbd> or <kbd>/</kbd> to search in the book</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
                sidebar_toggle.checked = false;
            }
            if (sidebar === 'visible') {
                sidebar_toggle.checked = true;
            } else {
                html.classList.remove('sidebar-visible');
            }
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search (`/`)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="/ s" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Rust Compiler Development Guide</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/rust-lang/rustc-dev-guide" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                        <a href="https://github.com/rust-lang/rustc-dev-guide/edit/main/src/solve/canonicalization.md" title="Suggest an edit" aria-label="Suggest an edit" rel="edit">
                            <i id="git-edit-button" class="fa fa-edit"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <div class="search-wrapper">
                            <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                            <div class="spinner-wrapper">
                                <i class="fa fa-spinner fa-spin"></i>
                            </div>
                        </div>
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="canonicalization"><a class="header" href="#canonicalization">Canonicalization</a></h1>
<p>Canonicalization is the process of <em>isolating</em> a value from its context and is necessary
for global caching of goals which include inference variables.</p>
<p>The idea is that given the goals <code>u32: Trait&lt;?x&gt;</code> and <code>u32: Trait&lt;?y&gt;</code>, where <code>?x</code> and <code>?y</code>
are two different currently unconstrained inference variables, we should get the same result
for both goals. We can therefore prove <em>the canonical query</em> <code>exists&lt;T&gt; u32: Trait&lt;T&gt;</code> once
and reuse the result.</p>
<p>Let's first go over the way canonical queries work and then dive into the specifics of
how canonicalization works.</p>
<h2 id="a-walkthrough-of-canonical-queries"><a class="header" href="#a-walkthrough-of-canonical-queries">A walkthrough of canonical queries</a></h2>
<p>To make this a bit easier, let's use the trait goal <code>u32: Trait&lt;?x&gt;</code> as an example with the
assumption that the only relevant impl is <code>impl&lt;T&gt; Trait&lt;Vec&lt;T&gt;&gt; for u32</code>.</p>
<h3 id="canonicalizing-the-input"><a class="header" href="#canonicalizing-the-input">Canonicalizing the input</a></h3>
<p>We start by <em>canonicalizing</em> the goal, replacing inference variables with existential and
placeholders with universal bound variables. This would result in the <em>canonical goal</em>
<code>exists&lt;T&gt; u32: Trait&lt;T&gt;</code>.</p>
<p>We remember the original values of all bound variables in the original context. Here this would
map <code>T</code> back to <code>?x</code>. These original values are used later on when dealing with the query
response.</p>
<p>We now call the canonical query with the canonical goal.</p>
<h3 id="instantiating-the-canonical-goal-inside-of-the-query"><a class="header" href="#instantiating-the-canonical-goal-inside-of-the-query">Instantiating the canonical goal inside of the query</a></h3>
<p>To actually try to prove the canonical goal we start by instantiating the bound variables with
inference variables and placeholders again.</p>
<p>This happens inside of the query in a completely separate <code>InferCtxt</code>. Inside of the query we
now have a goal <code>u32: Trait&lt;?0&gt;</code>. We also remember which value we've used to instantiate the bound
variables in the canonical goal, which maps <code>T</code> to <code>?0</code>.</p>
<p>We now compute the goal <code>u32: Trait&lt;?0&gt;</code> and figure out that this holds, but we've constrained
<code>?0</code> to <code>Vec&lt;?1&gt;</code>. We finally convert this result to something useful to the caller.</p>
<h3 id="canonicalizing-the-query-response"><a class="header" href="#canonicalizing-the-query-response">Canonicalizing the query response</a></h3>
<p>We have to return to the caller both whether the goal holds, and the inference constraints
from inside of the query.</p>
<p>To return the inference results to the caller we canonicalize the mapping from bound variables
to the instantiated values in the query. This means that the query response is <code>Certainty::Yes</code>
and a mapping from <code>T</code> to <code>exists&lt;U&gt; Vec&lt;U&gt;</code>.</p>
<h3 id="instantiating-the-query-response"><a class="header" href="#instantiating-the-query-response">Instantiating the query response</a></h3>
<p>The caller now has to apply the constraints returned by the query. For this they first
instantiate the bound variables of the canonical response with inference variables and
placeholders again, so the mapping in the response is now from <code>T</code> to <code>Vec&lt;?z&gt;</code>.</p>
<p>It now equates the original value of <code>T</code> (<code>?x</code>) with the value for <code>T</code> in the
response (<code>Vec&lt;?z&gt;</code>), which correctly constrains <code>?x</code> to <code>Vec&lt;?z&gt;</code>.</p>
<h2 id="externalconstraints"><a class="header" href="#externalconstraints"><code>ExternalConstraints</code></a></h2>
<p>Computing a trait goal may not only constrain inference variables, it can also add region
obligations, e.g. given a goal <code>(): AOutlivesB&lt;'a, 'b&gt;</code> we would like to return the fact that
<code>'a: 'b</code> has to hold.</p>
<p>This is done by not only returning the mapping from bound variables to the instantiated values
from the query but also extracting additional <code>ExternalConstraints</code> from the <code>InferCtxt</code> context
while building the response.</p>
<h2 id="how-exactly-does-canonicalization-work"><a class="header" href="#how-exactly-does-canonicalization-work">How exactly does canonicalization work</a></h2>
<p>TODO: link to code once the PR lands and elaborate</p>
<ul>
<li>types and consts: infer to existentially bound var, placeholder to universally bound var,
considering universes</li>
<li>generic parameters in the input get treated as placeholders in the root universe</li>
<li>all regions in the input get all mapped to existentially bound vars and we "uniquify" them.
<code>&amp;'a (): Trait&lt;'a&gt;</code> gets canonicalized to <code>exists&lt;'0, '1&gt; &amp;'0 (): Trait&lt;'1&gt;</code>. We do not care
about their universes and simply put all regions into the highest universe of the input.</li>
<li>in the output everything in a universe of the caller gets put into the root universe and only
gets its correct universe when we unify the var values with the orig values of the caller</li>
<li>we do not uniquify regions in the response and don't canonicalize <code>'static</code></li>
</ul>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../solve/candidate-preference.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../solve/coinduction.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../solve/candidate-preference.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../solve/coinduction.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->
        <script src="../mermaid.min.js"></script>
        <script src="../mermaid-init.js"></script>
        <script src="../pagetoc.js"></script>



    </div>
    </body>
</html>
